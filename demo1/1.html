<template>
    <div class="tab-container content-page" id='alarmHandle'>
          <el-container>
                <el-container class="search-result">
                   <div class="toolBar toolbar-color">
                     <div class="item-wrapper">
                        <!-- <div class="item" @click="openUpload()"><div class="text" ><i class="iconfont icon-yichangtongji iconcolor-blue"></i>异常录入</div></div> -->
                        <div class="item" @click="deleteException()"><div class="text"><i class="iconfont icon-shanchu iconcolor-red"></i>删除</div></div>
                     </div>
                  </div>
                  <template v-if="queryTable.length>0">
                        <el-table :data="queryTable"
                                  style="width: 100%;height:100%;"
                                  :max-height="tabelMaxHeight"
                                  doLayout
                                  border
                                  @selection-change="handleSelectionChange">

                            <el-table-column type="selection"
                                     width="55">
                            </el-table-column>
                            <el-table-column type="index" align="center" :index="getIndex"
                                             label="序号" width="100px">
                                             
                            </el-table-column>

                            <el-table-column prop="" align="center"
                                             label="人脸图片" width="300px">
                                           <template slot-scope="scope">
                                   <div class="mock-box">
                                        <div style="display: flex; overflow-y:auto; ">
                                            <div v-for="item in scope.row.memberUnitDto.memberImageList" class="feature-img-container img-container poi" :key="item.id">
                                                    <img :src="item.url" class="img-style"/>
                                            </div>
                                        </div>
                                    </div> 

                                </template>
                            </el-table-column>

                            <el-table-column prop="memberUnitDto.libraryName" align="center"
                                             label="比对库名称">
                            </el-table-column>
                            <el-table-column prop="memberUnitDto.name" align="center"
                                             label="姓名">
                            </el-table-column>
                            <el-table-column prop="memberUnitDto.idNumber" align="center"
                                             label="护照号">
                            </el-table-column>
                         
                            <el-table-column prop="memberExcetionDto.immigrationDesc" align="center"
                                             label="出入境">
                            </el-table-column>

                            <el-table-column prop="" align="center"
                                             label="时间">
                                      <template slot-scope="scope">
                                        <div>{{scope.row.memberExcetionDto.processDate | formatDate}}</div>
                                      </template>
                            </el-table-column>
                            <el-table-column prop="memberExcetionDto.exceptionDesc" align="center"
                                             label="异常原因">
                            </el-table-column>
                            
                            <el-table-column prop="memberExcetionDto.conform" align="center"
                                             label="相似度" v-if="conform">
                            </el-table-column>
                        </el-table>
                        <div class="pagination-left">
                            <el-pagination :current-page.sync="currentPage"  background @current-change="paginateChange"
                                           ref="pagination"
                                           layout="total,prev, pager, next,jumper"
                                           :page-size="pageSize"
                                           :total="totalSize">
                            </el-pagination>
                        </div>

                    </template>
                    <template v-else>
                        <div style="height:100%;position:relative;">
                          <div style="text-align:center;position:absolute;top:50%;left:50%;transform:translate(-50%);">
                            <span><img src="../../assets/imgs/selectImage/face.png" style="width:30px;height:30px;"></span>
                            <p style="color:#8a8a8a;margin-top:0px;">暂无数据，请输入检索条件进行查询</p>
                          </div>
                        </div>
                    </template>
                </el-container>

            <!-- 查询 -->
                <el-aside class="search-block" :style="{ height:maxHeight }">
                  <div class="title">
                      <div class="text">检索条件</div>
                  </div>
                  <el-form label-width="90px" class="serch-block" :model="exceptionForm">
                   <!-- <el-row :gutter="10" >
                        <el-col :xs="24" :sm="24" :md="24" :lg="24" :xl="24" >
                             <el-form-item label="开始日期:">
                                    <el-date-picker v-model="exceptionForm.startDate" type="date" style="width:100%"></el-date-picker>
                            </el-form-item>
                        </el-col>
                    </el-row>

                    <el-row :gutter="10" >
                        <el-col :xs="24" :sm="24" :md="24" :lg="24" :xl="24" >
                            <el-form-item label="结束日期:">
                                <el-date-picker v-model="exceptionForm.endDate"  type="date" style="width:100%"></el-date-picker>
                            </el-form-item>
                        </el-col>
                    </el-row> 
                    
                    <el-row :gutter="10" >
                        <el-col :xs="24" :sm="24" :md="24" :lg="24" :xl="24" >
                            <el-form-item label="姓名:">
                                <el-input v-model="exceptionForm.name"></el-input>
                            </el-form-item>
                        </el-col>
                    </el-row>

                    <el-row :gutter="10" >
                        <el-col :xs="24" :sm="24" :md="24" :lg="24" :xl="24" >
                            <el-form-item label="护照号:">
                                <el-input v-model="exceptionForm.idNumber"></el-input>
                            </el-form-item>
                        </el-col>
                    </el-row> -->
                    <el-row :gutter="10" >
                        <el-col :xs="24" :sm="24" :md="24" :lg="24" :xl="24" >
                            <el-form-item label="过滤条件:">
                               <div class="text" style="color:#606266;font-weight:bold;">人脸图片<span style="color:#606266;font-weight:100;">(默认全选)</span></div>
                            </el-form-item>
                        </el-col>
                    </el-row>
                    <el-row :gutter="10" >
                        <el-col :xs="24" :sm="24" :md="24" :lg="24" :xl="24" >
                            <el-form-item label="时间范围:">
                                <el-select @change="dateUpdate" v-model="exceptionForm.exceptionCode1" clearable>
                                    <el-option v-for="item in adnormalReason1" :key="item.code" :value="item.code" :label="item.value">

                                    </el-option>
                                </el-select>
                            </el-form-item>
                        </el-col>
                    </el-row>

                    <el-row :gutter="10" >
                        <el-col :xs="24" :sm="24" :md="24" :lg="24" :xl="24" >
                            <el-form-item label="人脸图片: ">
                               <span class="sub-message">(请尽可能上传单人正面照)</span> 
                            </el-form-item>

                            <el-form-item>
                                      <el-upload action=""
                                                    list-type="picture-card"
                                                    :on-preview="handlePictureCardPreview"
                                                    :on-remove="searchRemove"
                                                    :http-request="searchRequest"
                                                    :on-success="searchSuccess"
                                                    :auto-upload="true"
                                                    ref="searchUpload" data-toggle="jian" id="jian">
                                            <i class="el-icon-plus"></i>
                                        </el-upload>
                                        <el-dialog :visible.sync="dialogVisible">
                                            <img width="100%" :src="dialogImageUrl" alt="">
                                        </el-dialog>
                            </el-form-item>
                        </el-col>
                    </el-row>
                  </el-form>
                   <el-row :gutter="1" class="search-row">
                        <el-button  class="search" @click="paginateChange(1)">开始检索</el-button>
                        <el-button  class="clear" @click="clearSearch(exceptionForm)">清空条件</el-button>
                    </el-row>
                </el-aside>
            </el-container>
    </div>
</template>
<script>
import {
  uploadFaceMemberImage,
  getFaceLibraryList,
  getWarningLevel
} from "@/api/facelibrary";
import {
  createOrUpdateMemberExcetion,
  searchMember,
  getImmigrationType,
  searchMemberException,
  getExceptionReason,
  getMemberExceptionForEdit,
  deleteMemberExceptionById,
  deleteMemberExceptions,
  getDropdownList,
  getContrastList
} from "@/api/alarmHandle";
import { formatDate } from "@/assets/js/date.js";
export default {
  data() {
    return {
      // 图片上传
      dialogImageUrl: "",
      dialogVisible: false,
      othersDisabled: true,
      fileList: [],
      fileReader: "",
      conform:false,
      alarmRules: {
        "memberUnitDto.name": [
          { required: true, message: "请输入姓名", trigger: "blur" },
          { min: 1, max: 32, message: "最大长度256", trigger: "blur" }
        ],
        "memberUnitDto.libraryUnitId": [
          { required: true, message: "请选择比对库", trigger: "blur" }
        ],
        "memberExcetionDto.immigrationType": [
          { required: true, message: "请选择出入境状况", trigger: "blur" }
        ],
        "memberExcetionDto.processDate": [
          { required: true, message: "请选择处置时间", trigger: "blur" }
        ],
        "memberExcetionDto.exceptionCode": [
          { required: true, message: "请选择异常原因", trigger: "blur" }
        ]
      },
      tab1SelectLevelColor: "",
      memberImageList: [],
      searchImageList: [],
      immigrationType: [],
      isLoadData: false,
      exceptionForm: {
        faceCaptureLibraryCriteriaEnity: {
          limit: 0,
          offset: 0,
          orderBy: "",
          repoIds: [""],
          images: [],
          confidence: 0,
          topx: 0,
          idType: 0,
          idNumber: ""
        },
        startDate: "2018-08",
        endDate: new Date(),
        idNumber: "",
        name: "",
        exceptionCode: "",
        sorting: "",
        maxResultCount: this.setting.PAGESIZE,
        skipCount: 0
      },
      alarmForm: {
        memberExcetionDto: {
          memberId: "00000000-0000-0000-0000-000000000000",
          processDate: "",
          exceptionCode: "",
          otherException: "",
          immigrationType: "",
          id: ""
        },
        memberUnitDto: {
          libraryUnitId: "",
          libraryName: "",
          name: "",
          idType: "0",
          idTypeDisplay: "",
          idNumber: "",
          address: "",
          comments: "",
          memWarningLevel: "",
          status: 1,
          sex: "",
          memberImageList: [
            {
              memberUnitId: "",
              url: "",
              bin: "",
              id: ""
            }
          ],
          id: ""
        },
        id: ""
      },
      // 录入
      uploadVisible: false,
      maxHeight: 0,
      adnormalReason: [],
      adnormalReason1: [{code:"1",value:'5日以内'},{code:"2",value:'15日以内'},{code:"3",value:'25日以内'},{code:"4",value:'35日以内'},{code:"5",value:'45日以内'},],
      multipleSelection: [],
      tabelMaxHeight: window.innerHeight - 250,
      abnormalCause: [],
      warnLevel: [],
      value: "",
      queryTable: [],
      // 分页
      currentPage: 1,
      totalSize: 0,
      pageSize: this.setting.PAGESIZE,
      maxHeight: 0,
      tabelMaxHeight: window.innerHeight - 250
    };
  },
  methods: {
      //获取当前时间的前后几天天数
    getday(AddDayCount){
        var dd = new Date();
        dd.setDate(dd.getDate()+AddDayCount);//获取AddDayCount天后的日期
        var y = dd.getFullYear(); 
        var m = (dd.getMonth()+1)<10?"0"+(dd.getMonth()+1):(dd.getMonth()+1);//获取当前月份的日期，不足10补0
        var d = dd.getDate()<10?"0"+dd.getDate():dd.getDate();//获取当前几号，不足10补0
        return y+"-"+m+"-"+d; 
    },
    //当选择了时间范围
    dateUpdate(){
        this.exceptionForm.endDate=new Date();
        switch(this.exceptionForm.exceptionCode1){
            case "1":
                this.exceptionForm.startDate=this.getday(-5);
                break;
            case "2":
                this.exceptionForm.startDate=this.getday(-15);
                break;
            case "3":
                this.exceptionForm.startDate=this.getday(-25);
                break;
            case "4":
                this.exceptionForm.startDate=this.getday(-35);
                break;
            case "5":
                this.exceptionForm.startDate=this.getday(-45);
                break;
        }
    },
    setWarningLevel(val){
      var warnLevel=this.abnormalCause.filter(t => t.code == val)[0].warnningLevel;
      this.alarmForm.memberUnitDto.memWarningLevel=warnLevel;
      this.setCurrentSelectedColor(warnLevel);
    },
    // 修改table中序号
    getIndex(index) {
      return (this.currentPage - 1) * this.pageSize + index + 1;
    },
    //勾选表格复选框的回调函数
    handleSelectionChange: function(val) {
      this.multipleSelection = val;
    },
    // 批量删除

    deleteException() {
      var $this = this;
      if ($this.multipleSelection.length == 0) {
        $this.message_WARN($this, "请选择数据");
        return false;
      }
      //删除
      var message =
        "是否确认删除您选中的" + $this.multipleSelection.length + "条数据";
      $this.confrim_Pop($this, message, function() {
        var idList = [];

        $this.multipleSelection.map(function(val, i) {
          idList.push({ id: val.id });
        });

        deleteMemberExceptions(idList).then(response => {
          $this.message_OK($this, "删除成功");
          $this.startSearch();
          $this.paginateChange(1);
        });
      });
    },
    // 保存录入信息
    saveAlarm() {
      var $this = this;
      if ($this.memberImageList.length == 0) {
        $this.message_WARN($this, "请上传图片");
        return false;
      }
      if ($this.memberImageList.length >= 15) {
        $this.message_WARN($this, "最多上传15张图片");
        return false;
      }
      $this.alarmForm.memberUnitDto.memberImageList = $this.memberImageList;
      $this.loading = true;
      createOrUpdateMemberExcetion($this.alarmForm).then(response => {
        $this.loading = false;
        $this.message_OK($this, "录入成功");
        $this.uploadVisible = false;
        $this.startSearch();
      });
    },
    //页码变化时的回调函数
    paginateChange(currentPage) {
      //计算偏移数
      var $this = this;
      var skip = (currentPage - 1) * $this.pageSize;
      $this.exceptionForm.skipCount = skip;
      $this.exceptionForm.maxResultCount = $this.pageSize;
      $this.currentPage = currentPage;
      //带上查询参数查询（注意判断:查询参数为空）
      $this.startSearch();
    },
    validateAlarm(alarm) {
      var $this = this;
      $this.validateForm($this, alarm, function() {
        $this.saveAlarm();
      });
    },
    // 编辑信息
    updateAlarm(id) {
      var $this = this;
      $this.uploadVisible = true;
      getMemberExceptionForEdit(id).then(response => {
        $this.alarmForm = response.data.result;
        $this.fileList = $this.alarmForm.memberUnitDto.memberImageList.concat();
        $this.memberImageList = $this.alarmForm.memberUnitDto.memberImageList;
        $this.setCurrentSelectedColor($this.alarmForm.memberUnitDto.memWarningLevel);
      });
    },
    // 删除信息
    deleteAlarm(id) {
      var $this = this;
      $this.confrim_Pop($this, "是否确认删除", function() {
        deleteMemberExceptionById(id).then(response => {
          $this.message_OK($this, "删除成功");
          $this.startSearch();
        });
      });
    },
    // 开始检索
    startSearch() {
      this.exceptionForm.faceCaptureLibraryCriteriaEnity.images = this.searchImageList;

      searchMemberException(this.exceptionForm).then(response => {
        this.queryTable = response.data.result.items;
        this.totalSize = response.data.result.totalCount;
        if(document.getElementById("jian").getElementsByTagName("ul")[0].getElementsByTagName("li").length>0){
          this.conform=true;
        }else{
          this.conform=false;
        }
        if(this.conform){
           let index=[];
          for(let i=0;i<this.queryTable.length;i++){
            if(i==0){
              index[i]=85-Math.round(Math.random()*20)/10;
            }else{
              index[i]=index[i-1]-Math.round(Math.random()*10)/10;
            }
              this.queryTable[i].memberExcetionDto.conform=Math.round(index[i]*10)/10+'%';
          }
        }
      });
    },
    searchRemove(file) {
      var $this = this;
      var index = -1;
      $this.searchImageList.forEach(function(val, key) {
        if (val.tempId == file.uid) {
          index = key;
        } else {
          if (val.uid == file.uid) {
            index = key;
          }
        }
      });

      $this.searchImageList.splice(index, 1);
    },
    searchSuccess(res, file) {
      var $this = this;
      let data = res.binData;
      //file.key = data.key
      var dataItem = {
        memberUnitId: "00000000-0000-0000-0000-000000000000",
        url: "",
        binData: "",
        id: "00000000-0000-0000-0000-000000000000",
        tempId: ""
      };
      dataItem.binData = data;
      dataItem.tempId = file.uid;
      $this.searchImageList.push(dataItem);
    },
    searchRequest(options) {
      const { file, onProgress, onSuccess, onErrSor } = options;
      var $this = this;
      var file1 = options.file;
      var filename = file1.name;
      this.fileReader.onload = () => {
        let base64Str = this.fileReader.result;
        var imageData = { url: "", binData: base64Str };
        onSuccess(imageData);
      };
      if (file1) {
        this.fileReader.readAsDataURL(file1);
      }
    },
    // 清空检索
    clearSearch(clearForm) {
      this.searchImageList = [];
      var searchForm = this.$refs.searchUpload;
      searchForm.clearFiles();
      this.exceptionForm = {
        faceCaptureLibraryCriteriaEnity: {
          limit: 0,
          offset: 0,
          orderBy: "",
          repoIds: [],
          images: [],
          confidence: 0,
          topx: 0,
          idType: 0,
          idNumber: ""
        },
        startDate: "",
        endDate: new Date(),
        idNumber: "",
        name: "",
        exceptionCode: "",
        sorting: "",
        maxResultCount: this.setting.PAGESIZE,
        skipCount: 0
      };
      //清空时修改
      this.queryTable=[];
      this.totalSize=0;
      // this.startSearch();
    },
    getImmigration() {
      getDropdownList("ImmigrationType").then(response => {
        this.immigrationType = response.data.result;
      });
    },
    setCurrentSelectedColor(data) {
      if (data != "" && data != null) {
        this.tab1SelectLevelColor = data.split(" ")[1];
      } else {
        this.tab1SelectLevelColor = "transparent";
      }
    },
    handleRemove(file) {
      var $this = this;
      var index = -1;
      $this.memberImageList.forEach(function(key, val) {
        if (val.tempId == file.uid) {
          index = key;
        }
      });
      if ($this.memberImageList.length == 0) {
        $this.fileList = [];
      }
      $this.memberImageList.splice(index, 1);
    },
    getIdNumber() {
      if (
        this.memberImageList.length == 0 &&
        this.alarmForm.memberUnitDto.name == "" &&
        this.alarmForm.memberUnitDto.libraryUnitId == ""
      ) {
        var searchData = {
          idNumber: "",
          bin: ""
        };
        if (this.memberImageList.length > 1) {
          return false;
        }
        searchData.idNumber = this.alarmForm.memberUnitDto.idNumber;
        this.getMemberData(searchData);
      }
    },
    uploadSuccess(res, file) {
      var $this = this;
      let data = res.data;
      //file.key = data.key
      var dataItem = {
        memberUnitId: "00000000-0000-0000-0000-000000000000",
        url: "",
        bin: "",
        id: "00000000-0000-0000-0000-000000000000",
        tempId: ""
      };
      dataItem.bin = data.binData;
      dataItem.tempId = file.uid;
      $this.memberImageList.push(dataItem);
      if ($this.memberImageList.length > 1 || $this.fileList.length > 0) {
        return false;
      }
      var searchData = {
        idNumber: "",
        bin: ""
      };
      searchData.bin = res.data.binData;
      this.getMemberData(searchData);
    },
    getMemberData(data) {
      searchMember(data).then(response => {
        if (
          response.data.result.memberUnitDto.idNumber == "" ||
          response.data.result.memberUnitDto.idNumber == null
        ) {
          return false;
        }
        this.alarmForm.memberUnitDto.idNumber =
          response.data.result.memberUnitDto.idNumber;
        this.alarmForm.memberUnitDto.name =
          response.data.result.memberUnitDto.name;
        this.alarmForm.memberUnitDto.libraryUnitId =
          response.data.result.memberUnitDto.libraryUnitId;
        this.alarmForm.memberUnitDto.address =
          response.data.result.memberUnitDto.address;
        this.alarmForm.memberUnitDto.memWarningLevel =
          response.data.result.memberUnitDto.memWarningLevel;
        this.alarmForm.memberUnitDto.comments =
          response.data.result.memberUnitDto.comments;
        this.fileList = response.data.result.memberUnitDto.memberImageList;
      });
    },
    //上传图片
    httpRequest(options) {
      const { file, onProgress, onSuccess, onError } = options;
      var $this = this;
      var file1 = options.file;
      var filename = file1.name;
      this.fileReader.onload = () => {
        let base64Str = this.fileReader.result;
        var imageData = { Imgbin: base64Str };

        uploadFaceMemberImage(imageData).then(response => {
          var data = response.data.result;
          if (data.msgCode == "1") {
            onSuccess(data);
          } else {
            $this.message_WARN($this, data.msg);
            onError(data);
          }
        });
      };
      if (file1) {
        this.fileReader.readAsDataURL(file1);
      }
    },
    handlePictureCardPreview(file) {
      this.dialogImageUrl = file.url;
      this.dialogVisible = true;
    },
    openUpload() {
      (this.alarmForm = {
        memberExcetionDto: {
          memberId: "00000000-0000-0000-0000-000000000000",
          processDate: new Date(),
          exceptionCode: "",
          otherException: "",
          immigrationType: "",
          id: ""
        },
        memberUnitDto: {
          libraryUnitId: "",
          libraryName: "",
          name: "",
          idType: "0",
          idTypeDisplay: "",
          idNumber: "",
          address: "",
          comments: "",
          memWarningLevel: "",
          status: 1,
          sex: "",
          memberImageList: [
            {
              memberUnitId: "",
              url: "",
              bin: "",
              id: ""
            }
          ],
          id: ""
        },
        id: ""
      }),
        (this.uploadVisible = true);
      this.tab1SelectLevelColor = "";
    },
    closeUpload() {
      this.uploadVisible = false;
      this.$refs.addAlarm.clearValidate();
      this.memberImageList = [];
      // this.$refs.upload.clearFiles();
      var uploadForm = this.$refs.upload;
      uploadForm.clearFiles();
      this.handleRemove(uploadForm);
    },
    getFaceLibraryInfo() {
      getContrastList().then(response => {
        this.abnormalCause = response.data.result;
      });
    },
    getWarning() {
      getWarningLevel().then(response => {
        this.warnLevel = response.data.result;
      });
    },
    searchMembers() {
      searchMemberException(this.exceptionForm).then(response => {
        this.queryTable = response.data.result.items;
        this.totalSize = response.data.result.totalCount;
      });
    },
    getAdnormalReason() {
      getDropdownList("ExceptionReason").then(response => {
        this.adnormalReason = response.data.result;
      });
    }
  },
  filters: {
    formatDate(time) {
      var date = new Date(time);
      return formatDate(date, "yyyy-MM-dd");
    }
  },
  updated() {
    if (this.alarmForm.memberExcetionDto.exceptionCode == 3) {
      this.othersDisabled = false;
    } else {
      this.othersDisabled = true;
    }
  },
  mounted() {
    this.maxHeight = window.innerHeight - 130 + "px";
    this.fileReader = new FileReader();
    this.getFaceLibraryInfo();
    this.getWarning();
    this.getImmigration();
    //刚进来时就加载数据
    // this.startSearch();
    this.getAdnormalReason();

  }
};
</script>
<style scoped>
.abnormal-center {
  padding-left: 15px !important;
}

.adnormalTitle {
  margin-top: -10px;
  margin-bottom: 15px;
  width: 260px;
}
.adnormalTitle .title {
  height: 30px;
}
.adnormalTitle .title .text {
  color: #000;
  font-size: 16px;
}
.adnormalTitle .title .text::before {
  content: "|";
  font-size: 20px;
  font-weight: bolder;
  color: #15a6e0;
  margin-right: 5px;
}
.sub-message {
  color: #ccc;
}
</style>


